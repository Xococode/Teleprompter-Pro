<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teleprompter Pro ‚Ä¢ Con Lectura de Voz Autom√°tica</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéôÔ∏è</text></svg>">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
    :root {
      --bg-primary: #111827; --bg-secondary: #1f2937; --panel-bg: #1a2231; --panel-border: #374151; --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-muted: #9ca3af;
      --accent-primary: #3b82f6; --accent-secondary: #2563eb; --accent-hover: #60a5fa; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); --border-radius: 0.75rem; --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); --text-width: 900px;
    }
    body.theme-light { --bg-primary: #f9fafb; --bg-secondary: #f3f4f6; --panel-bg: #ffffff; --panel-border: #d1d5db; --text-primary: #111827; --text-secondary: #374151; --text-muted: #6b7280; }
    body.theme-sepia { --bg-primary: #fbf5e9; --bg-secondary: #f4eade; --panel-bg: #fffaf0; --panel-border: #e4d8c6; --text-primary: #433422; --text-secondary: #5f4c3a; --text-muted: #917f6d; }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); display: grid; grid-template-rows: auto 1fr auto; height: 100vh; overflow: hidden; }
    header { background: rgba(31,41,55,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--panel-border); padding: .75rem; position: relative; z-index: 100; transition: max-height 0.5s ease-in-out, padding 0.5s; overflow: hidden; max-height: 500px; }
    body.theme-light header, body.theme-sepia header { background: rgba(255,255,255,0.8); }
    header.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; border-bottom-width: 0; }
    .header-toggle-button { position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%) translateY(100%); background: var(--panel-bg); border: 1px solid var(--panel-border); border-top: none; border-radius: 0 0 .5rem .5rem; padding: .2rem 1rem; cursor: pointer; z-index: 99; }
    .header-content { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; justify-content: center; max-width: 1600px; margin: 0 auto; }
    .control-group { display: flex; align-items: center; gap: .75rem; padding: .5rem; background: var(--bg-secondary); border: 1px solid var(--panel-border); border-radius: var(--border-radius); box-shadow: var(--shadow); }
    .control-label { font-size: .875rem; color: var(--text-muted); font-weight: 500; }
    .btn { background: var(--panel-bg); color: var(--text-secondary); border: 1px solid var(--panel-border); padding: .6rem 1rem; border-radius: .5rem; cursor: pointer; font-weight: 600; font-size: .875rem; transition: var(--transition); display: flex; align-items: center; gap: .5rem; }
    .btn:hover { border-color: var(--accent-hover); background: var(--bg-secondary); color: var(--text-primary); transform: translateY(-2px); }
    .btn.primary { background: linear-gradient(145deg, var(--accent-primary), var(--accent-secondary)); color: white; border-color: var(--accent-secondary); }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
    .btn.success { background: var(--success); border-color: var(--success); color: white; }
    .btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-secondary); }
    input[type="range"] { width: 80px; }
    input[type="number"], select { width: auto; text-align: center; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--panel-border); border-radius: 0.5rem; padding: 0.4rem; }
    select { max-width: 150px; }
    main { display: grid; grid-template-columns: 400px 1fr; gap: 1.5rem; padding: 1.5rem; height: 100%; overflow: hidden; max-width: 1600px; margin: 0 auto; width: 100%; }
    .script-panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: var(--border-radius); padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
    .script-textarea { width: 100%; flex: 1; resize: none; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--panel-border); border-radius: .5rem; padding: 1rem; line-height: 1.7; font-family: 'JetBrains Mono', monospace; }
    .script-actions { display: flex; gap: .5rem; flex-wrap: wrap; }
    .stage { background: var(--bg-primary); border: 1px solid var(--panel-border); border-radius: var(--border-radius); position: relative; overflow: hidden; }
    .viewport { width: 100%; height: 100%; overflow: hidden; position: relative; }
    .focus-guide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0; transition: opacity .3s; background: linear-gradient(to bottom, var(--bg-primary) 0%, rgba(0,0,0,0) 48%, rgba(0,0,0,0) 52%, var(--bg-primary) 100%); }
    .stage.focus-guide-active .focus-guide { opacity: 1; }
    .content { padding: 45vh 2.5rem; max-width: var(--text-width); margin: 0 auto; will-change: transform; }
    .text { font-weight: 600; line-height: var(--line-height, 1.6); font-size: var(--font-size, 48px); }
    .text p { margin-bottom: 1.5em; }
    .mirrored { transform: scaleX(-1); } .mirrored .content { transform: scaleX(-1); }
    .countdown { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: clamp(5rem, 20vw, 15rem); color: var(--accent-primary); background: rgba(17,24,39,0.9); backdrop-filter: blur(8px); z-index: 50; }
    .progress-container { position: absolute; bottom: 0; left: 0; right: 0; height: 8px; background: rgba(127,127,127,0.2); cursor: pointer; }
    .progress-bar { height: 100%; background: var(--accent-primary); }
    .stats-panel { position: absolute; top: 1rem; right: 1rem; background: rgba(31,41,55,0.8); border: 1px solid var(--panel-border); border-radius: .75rem; padding: .75rem; backdrop-filter: blur(10px); z-index: 40; min-width: 280px; transition: var(--transition); }
    body.theme-light .stats-panel, body.theme-sepia .stats-panel { background: rgba(255,255,255,0.8); }
    .stats-panel.hidden { opacity: 0; pointer-events: none; transform: translateY(-10px); }
    .stats-row { display: flex; gap: 1rem; } .stats-row:not(:last-child) { margin-bottom: .5rem; }
    .stat-item { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .stat-label { font-size: .75rem; color: var(--text-muted); }
    .stat-value { font-size: .875rem; color: var(--accent-primary); font-weight: 600; }
    .text .word { transition: all .2s ease-in-out; padding: 0 2px; border-radius: 4px; }
    .text.karaoke-mode .word.current { background: var(--accent-primary); color: white; }
    .text.karaoke-mode .word.passed { color: var(--text-muted); opacity: .7; }
    .text .word.speaking { background-color: rgba(245, 158, 11, 0.5); color: var(--text-primary); }
    footer { background: var(--bg-secondary); border-top: 1px solid var(--panel-border); padding: .75rem; color: var(--text-muted); font-size: .8rem; }
    .footer-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    kbd { background: var(--bg-primary); border: 1px solid var(--panel-border); border-bottom-width: 3px; padding: .2rem .4rem; border-radius: .375rem; font-family: 'JetBrains Mono', monospace; }
    @media (max-width: 900px) { main { grid-template-columns: 1fr; grid-template-rows: 1fr auto; } .script-panel { order: 2; height: 300px; } .stage { order: 1; } .header-content { flex-direction: column; align-items: stretch; } .control-group { justify-content: space-between; } }
  </style>
</head>
<body class="theme-dark">
  <header id="appHeader">
    <div class="header-content">
      <div class="control-group">
        <button id="playPause" class="btn primary">‚ñ∂ Empezar</button>
        <button id="reset" class="btn">‚Üª Reset</button>
        <button id="fullscreen" class="btn">‚õ∂</button>
      </div>
      <div class="control-group">
        <label>Velocidad</label><input id="speed" type="range" min="0" max="400" step="5" value="80"/><span id="speedVal">80</span>
        <label>Tama√±o</label><input id="fontSize" type="range" min="20" max="120" step="2" value="48"/><span id="fontVal">48</span>
        <label>Ancho</label><input id="textWidth" type="range" min="400" max="1200" step="20" value="900"/><span id="widthVal">900</span>
      </div>
      <div class="control-group">
        <label>Espejo</label><input id="mirror" type="checkbox" />
        <label>Gu√≠a</label><input id="focusGuide" type="checkbox" />
        <label>Cuenta atr√°s</label><input id="countdown" type="number" min="0" max="10" value="3"/>
      </div>
      <div class="control-group">
        <label>Karaoke</label><input id="karaoke" type="checkbox" />
        <label>Stats</label><input id="showStats" type="checkbox" checked />
        <div id="karaokeSpeedGroup" style="display: none;">
          <label>PPM</label><input id="karaokeSpeed" type="range" min="30" max="300" step="5" value="150"/><span id="karaokeSpeedVal">150</span>
        </div>
      </div>
      <div class="control-group">
        <button id="readAloudBtn" class="btn">üîä Leer</button>
        <select id="voiceSelect"></select>
      </div>
      <div class="control-group">
          <button id="alignLeft" class="btn active">Alinear Izq.</button><button id="alignCenter" class="btn">Cen.</button><button id="alignRight" class="btn">Der.</button>
      </div>
      <div class="control-group">
          <button id="themeDark" class="btn active">üåô</button><button id="themeLight" class="btn">‚òÄÔ∏è</button><button id="themeSepia" class="btn">üìú</button>
      </div>
    </div>
    <button id="headerToggle" class="header-toggle-button">‚¨ÜÔ∏è</button>
  </header>

  <main>
    <section class="script-panel">
      <h2>üìù Editor de Gui√≥n</h2>
      <textarea id="scriptInput" class="script-textarea" placeholder="Escribe tu gui√≥n aqu√≠...">¬°Lectura Autom√°tica Activada!

1. Haz clic en "üîä Leer". El bot√≥n cambiar√° a "üîä Armado".
2. Luego, haz clic en "‚ñ∂ Empezar".
3. ¬°La voz comenzar√° autom√°ticamente con el scroll!

La lectura se pausa y contin√∫a junto con el teleprompter. Para detenerla, presiona "Reset" o el bot√≥n "‚èπÔ∏è Detener".</textarea>
      <div class="script-actions">
        <button id="loadScript" class="btn success">üì§ Cargar</button>
        <button id="clearScript" class="btn danger">üóëÔ∏è Limpiar</button>
        <button id="saveScript" class="btn">üíæ Guardar</button>
        <button id="loadFile" class="btn">üìÅ Abrir</button>
        <input type="file" id="fileInput" accept=".txt" style="display: none;">
      </div>
    </section>

    <section class="stage" id="stage">
      <div class="viewport" id="viewport">
        <div class="focus-guide"></div>
        <div class="content" id="content"><div class="text" id="displayText"></div></div>
        <div class="countdown" id="countdownDisplay" style="display: none;"></div>
        <div class="progress-container" id="progressContainer"><div id="progressBar" class="progress-bar"></div></div>
        <div class="stats-panel" id="statsPanel">
            <div class="stats-row"><div class="stat-item"><span class="stat-label">Palabras</span><span class="stat-value" id="wordCount">0</span></div><div class="stat-item"><span class="stat-label">Caracteres</span><span class="stat-value" id="charCount">0</span></div><div class="stat-item"><span class="stat-label">Tiempo est.</span><span class="stat-value" id="estimatedTime">0:00</span></div></div>
            <div class="stats-row"><div class="stat-item"><span class="stat-label">Progreso</span><span class="stat-value" id="progressPercent">0%</span></div><div class="stat-item"><span class="stat-label">Tiempo real</span><span class="stat-value" id="realTime">0:00</span></div><div class="stat-item" id="karaokeStatus" style="display: none;"><span class="stat-label">Modo</span><span class="stat-value" id="karaokeMode">Scroll</span></div></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <div class="shortcuts"><kbd>Espacio</kbd> Play/Pause | <kbd>M</kbd> Espejo | <kbd>S</kbd> Stats | <kbd>K</kbd> Karaoke</div>
      <div class="shortcuts"><kbd>ReP√°g</kbd>/<kbd>AvP√°g</kbd> Navegar | <kbd>Inicio</kbd>/<kbd>Fin</kbd> Extremos</div>
    </div>
  </footer>

  <script>
    class TeleprompterApp {
      constructor() {
        this.initializeElements();
        this.initializeState();
        this.setupEventListeners();
        this.populateVoices();
        this.loadPreferences();
        this.updateUI();
        this.loadScript();
      }

      initializeElements() {
        const ids = ['body', 'appHeader', 'headerToggle', 'playPause', 'reset', 'fullscreen', 'speed', 'speedVal', 'fontSize', 'fontVal', 'textWidth', 'widthVal', 'mirror', 'focusGuide', 'countdown', 'karaoke', 'showStats', 'karaokeSpeedGroup', 'karaokeSpeed', 'karaokeSpeedVal', 'alignLeft', 'alignCenter', 'alignRight', 'themeDark', 'themeLight', 'themeSepia', 'readAloudBtn', 'voiceSelect', 'scriptInput', 'loadScript', 'clearScript', 'saveScript', 'loadFile', 'fileInput', 'stage', 'viewport', 'content', 'displayText', 'countdownDisplay', 'progressContainer', 'progressBar', 'statsPanel', 'wordCount', 'charCount', 'estimatedTime', 'progressPercent', 'realTime', 'karaokeStatus', 'karaokeMode'];
        this.elements = {};
        ids.forEach(id => this.elements[id] = document.getElementById(id));
        this.elements.body = document.body;
      }

      initializeState() {
        this.state = {
          playing: false, lastTimestamp: 0, offsetY: 0, maxScroll: 0, animationId: null, countdownInterval: null,
          isHeaderCollapsed: false, currentWordIndex: 0, totalWords: 0, startTime: null, elapsedTime: 0,
          words: [], karaokeStartTime: null, textStats: { words: 0, characters: 0, charsWithSpaces: 0 },
          utterance: null, speechSynth: window.speechSynthesis, availableVoices: [],
          speechShouldStartWithScroll: false // NEW state to arm speech
        };
      }

      setupEventListeners() {
        Object.keys(this.eventHandlers).forEach(key => {
            const [element, event] = key.split(':');
            if (this.elements[element]) { this.elements[element].addEventListener(event, this.eventHandlers[key]); }
        });
        document.addEventListener('keydown', e => this.handleKeyboard(e));
        window.addEventListener('resize', () => this.updateMaxScroll());
        this.state.speechSynth.onvoiceschanged = () => this.populateVoices();
      }

      eventHandlers = {
        'playPause:click': () => this.togglePlayPause(), 'reset:click': () => this.reset(), 'fullscreen:click': () => this.toggleFullscreen(), 'headerToggle:click': () => this.toggleHeader(),
        'speed:input': e => this.updateSpeedUI(e.target.value), 'fontSize:input': e => this.updateFontSizeUI(e.target.value), 'textWidth:input': e => this.updateTextWidthUI(e.target.value),
        'mirror:change': e => this.elements.viewport.classList.toggle('mirrored', e.target.checked), 'focusGuide:change': e => this.elements.stage.classList.toggle('focus-guide-active', e.target.checked),
        'karaoke:change': e => this.toggleKaraoke(e.target.checked), 'showStats:change': e => this.toggleStats(e.target.checked), 'karaokeSpeed:input': e => this.updateKaraokeSpeedUI(e.target.value),
        'alignLeft:click': () => this.setTextAlign('left'), 'alignCenter:click': () => this.setTextAlign('center'), 'alignRight:click': () => this.setTextAlign('right'),
        'themeDark:click': () => this.setTheme('theme-dark'), 'themeLight:click': () => this.setTheme('theme-light'), 'themeSepia:click': () => this.setTheme('theme-sepia'),
        'readAloudBtn:click': () => this.toggleSpeechArming(), // MODIFIED
        'loadScript:click': () => this.loadScript(), 'clearScript:click': () => this.clearText(), 'saveScript:click': () => this.saveScript(),
        'loadFile:click': () => this.elements.fileInput.click(), 'fileInput:change': e => this.handleFileLoad(e),
        'stage:wheel': e => this.handleMouseWheel(e), 'progressContainer:click': e => this.handleProgressClick(e)
      };

      populateVoices() {
          this.state.availableVoices = this.state.speechSynth.getVoices().filter(v => v.lang.startsWith('es') || v.lang.startsWith('en'));
          this.elements.voiceSelect.innerHTML = this.state.availableVoices.map((voice, i) => `<option value="${i}">${voice.name} (${voice.lang})</option>`).join('');
          this.loadPreferences(); // Re-apply saved voice after voices load
      }

      // --- SPEECH LOGIC: MODIFIED FOR ARMING ---
      toggleSpeechArming() {
        if (this.state.speechSynth.speaking) {
            this.state.speechSynth.cancel();
            this.state.speechShouldStartWithScroll = false;
            this.updateReadAloudButtonUI();
            return;
        }
        this.state.speechShouldStartWithScroll = !this.state.speechShouldStartWithScroll;
        this.updateReadAloudButtonUI();
      }

      startSpeech() {
        if (!this.state.speechShouldStartWithScroll || this.state.speechSynth.speaking) return;
        const text = this.elements.displayText.textContent;
        if (!text.trim()) return;

        this.state.utterance = new SpeechSynthesisUtterance(text);
        const selectedVoice = this.state.availableVoices[this.elements.voiceSelect.value];
        if (selectedVoice) this.state.utterance.voice = selectedVoice;
        
        this.state.utterance.onend = () => {
            this.state.speechShouldStartWithScroll = false;
            this.updateReadAloudButtonUI();
            this.state.words.forEach(w => w.classList.remove('speaking'));
        };
        this.state.utterance.onboundary = (event) => this.highlightSpokenWord(event);
        
        this.state.speechSynth.speak(this.state.utterance);
        this.updateReadAloudButtonUI();
      }

      updateReadAloudButtonUI() {
        if (this.state.speechSynth.speaking) {
            this.elements.readAloudBtn.textContent = '‚èπÔ∏è Detener';
            this.elements.readAloudBtn.classList.add('active');
        } else if (this.state.speechShouldStartWithScroll) {
            this.elements.readAloudBtn.textContent = 'üîä Armado';
            this.elements.readAloudBtn.classList.add('active');
        } else {
            this.elements.readAloudBtn.textContent = 'üîä Leer';
            this.elements.readAloudBtn.classList.remove('active');
        }
      }

      highlightSpokenWord(event) {
          if (event.name !== 'word') return;
          const textUpToBoundary = this.state.utterance.text.substring(0, event.charIndex);
          const wordIndex = (textUpToBoundary.match(/\s+/g) || []).length;
          this.state.words.forEach((word, index) => word.classList.toggle('speaking', index === wordIndex));
      }

      // --- General UI & Settings ---
      toggleHeader() { this.state.isHeaderCollapsed = !this.state.isHeaderCollapsed; this.elements.appHeader.classList.toggle('collapsed', this.state.isHeaderCollapsed); this.elements.headerToggle.textContent = this.state.isHeaderCollapsed ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'; setTimeout(() => this.updateMaxScroll(), 500); }
      updateSpeedUI(value) { this.elements.speedVal.textContent = value; }
      updateFontSizeUI(value) { this.elements.fontVal.textContent = value; document.documentElement.style.setProperty('--font-size', `${value}px`); this.updateMaxScroll(); }
      updateTextWidthUI(value) { this.elements.widthVal.textContent = value; document.documentElement.style.setProperty('--text-width', `${value}px`); this.updateMaxScroll(); }
      updateKaraokeSpeedUI(value) { this.elements.karaokeSpeedVal.textContent = value; }
      setTextAlign(align) { this.elements.displayText.style.textAlign = align; ['alignLeft','alignCenter','alignRight'].forEach(id=>this.elements[id].classList.remove('active')); this.elements[`align${align.charAt(0).toUpperCase()+align.slice(1)}`].classList.add('active'); }
      setTheme(theme) { this.elements.body.className = theme; ['themeDark','themeLight','themeSepia'].forEach(id=>this.elements[id].classList.remove('active')); this.elements[`theme${theme.split('-')[1].charAt(0).toUpperCase()+theme.split('-')[1].slice(1)}`].classList.add('active'); }
      toggleStats(visible) { this.elements.statsPanel.classList.toggle('hidden', !visible); }
      toggleKaraoke(enabled) { this.elements.displayText.classList.toggle('karaoke-mode', enabled); this.elements.karaokeSpeedGroup.style.display = enabled ? 'flex' : 'none'; this.elements.karaokeStatus.style.display = enabled ? 'flex' : 'none'; this.prepareWordSpans(); }
      handleMouseWheel(event) { event.preventDefault(); const delta = event.deltaY > 0 ? -5 : 5; const current = parseInt(this.elements.speed.value); this.elements.speed.value = Math.max(0,Math.min(400,current+delta)); this.updateSpeedUI(this.elements.speed.value); }

      // --- Core Logic ---
      loadScript() { const html = this.elements.scriptInput.value.split(/\n\s*\n/).map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join(''); this.elements.displayText.innerHTML = html; this.prepareWordSpans(); this.reset(); }
      clearText() { this.elements.scriptInput.value = ''; this.loadScript(); }
      prepareWordSpans() {
        const paragraphs = Array.from(this.elements.displayText.querySelectorAll('p'));
        paragraphs.forEach(p => { const words = p.textContent.split(/\s+/).filter(Boolean); p.innerHTML = words.map(word => `<span class="word">${word}</span>`).join(' '); });
        this.state.words = Array.from(this.elements.displayText.querySelectorAll('.word'));
        this.state.totalWords = this.state.words.length;
      }
      togglePlayPause() { this.state.playing ? this.pause() : this.startCountdown(); }
      startCountdown() {
        const seconds = parseInt(this.elements.countdown.value, 10) || 0;
        if (seconds <= 0) { this.start(); return; }
        this.elements.countdownDisplay.style.display = 'flex'; let remaining = seconds; this.elements.countdownDisplay.textContent = remaining;
        this.state.countdownInterval = setInterval(() => {
          remaining--; this.elements.countdownDisplay.textContent = remaining;
          if (remaining <= 0) { clearInterval(this.state.countdownInterval); this.elements.countdownDisplay.style.display = 'none'; this.start(); }
        }, 1000);
      }
      start() {
        if (this.state.speechSynth.paused) this.state.speechSynth.resume();
        this.startSpeech(); // ATTEMPT TO START SPEECH
        this.state.playing = true; this.state.lastTimestamp = performance.now();
        if (!this.state.startTime) this.state.startTime = Date.now();
        this.elements.playPause.textContent = '‚è∏ Pausar'; this.animate();
      }
      pause() {
        if (this.state.speechSynth.speaking) this.state.speechSynth.pause();
        this.state.playing = false; this.elements.playPause.textContent = '‚ñ∂ Continuar';
        cancelAnimationFrame(this.state.animationId);
        if (this.state.countdownInterval) { clearInterval(this.state.countdownInterval); this.elements.countdownDisplay.style.display = 'none'; }
      }
      reset() {
        this.pause(); if (this.state.speechSynth.speaking) this.state.speechSynth.cancel();
        this.state.speechShouldStartWithScroll = false; this.updateReadAloudButtonUI();
        this.state.offsetY = 0; this.state.currentWordIndex = 0; this.state.startTime = null; this.state.elapsedTime = 0;
        this.elements.content.style.transform = `translateY(0px)`;
        this.elements.playPause.textContent = '‚ñ∂ Empezar';
        this.calculateTextStats(); this.updateStatsDisplay(); this.updateMaxScroll();
      }
      animate() {
        if (!this.state.playing) return;
        const now = performance.now(); const deltaTime = (now - this.state.lastTimestamp) / 1000; this.state.lastTimestamp = now;
        this.state.offsetY += parseFloat(this.elements.speed.value) * deltaTime;
        if (this.state.offsetY >= this.state.maxScroll) { this.state.offsetY = this.state.maxScroll; this.pause(); }
        this.elements.content.style.transform = `translateY(${-this.state.offsetY}px)`;
        this.updateStatsDisplay(); if (this.elements.karaoke.checked) this.updateKaraokeHighlight();
        this.state.animationId = requestAnimationFrame(() => this.animate());
      }
      updateKaraokeHighlight() {
        if (!this.state.words.length || !this.elements.karaoke.checked) return;
        const progress = this.state.maxScroll > 0 ? this.state.offsetY / this.state.maxScroll : 0;
        let targetWordIndex = Math.floor(progress * this.state.totalWords);
        if (targetWordIndex !== this.state.currentWordIndex) { this.state.currentWordIndex = targetWordIndex; }
        this.state.words.forEach((el, idx) => { el.classList.remove('current', 'passed'); if (idx < this.state.currentWordIndex) el.classList.add('passed'); else if (idx === this.state.currentWordIndex) el.classList.add('current'); });
      }

      calculateTextStats() { const text = this.elements.displayText.textContent.trim(); const words = text ? text.split(/\s+/).filter(Boolean) : []; this.state.textStats = { words: words.length, characters: text.replace(/\s/g, '').length, charsWithSpaces: text.length }; this.updateStatsDisplay(); }
      updateStatsDisplay() {
        const { words, charsWithSpaces } = this.state.textStats; this.elements.wordCount.textContent = words; this.elements.charCount.textContent = charsWithSpaces;
        const ppm = parseInt(this.elements.karaokeSpeed.value, 10) || 150; this.elements.estimatedTime.textContent = this.formatTime(words / ppm * 60);
        const progress = this.state.maxScroll > 0 ? (this.state.offsetY / this.state.maxScroll) * 100 : 0; this.elements.progressPercent.textContent = `${Math.round(progress)}%`;
        if (this.state.startTime) this.state.elapsedTime = (Date.now() - this.state.startTime) / 1000; this.elements.realTime.textContent = this.formatTime(this.state.elapsedTime);
        this.elements.progressBar.style.width = `${progress}%`;
      }
      formatTime(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec.toString().padStart(2,'0')}`; }
      updateMaxScroll() { requestAnimationFrame(() => { this.state.maxScroll = Math.max(0, this.elements.content.scrollHeight - this.elements.viewport.clientHeight); this.updateStatsDisplay(); }); }

      handleProgressClick(e) { const p = (e.clientX-e.target.getBoundingClientRect().left)/e.target.offsetWidth; this.jumpToPosition(p*100); }
      jumpToPosition(p) { if (this.state.speechSynth.speaking) this.state.speechSynth.cancel(); this.state.offsetY = this.state.maxScroll * (p/100); this.elements.content.style.transform = `translateY(${-this.state.offsetY}px)`; this.updateStatsDisplay(); }
      jumpByPercentage(d) { const c=(this.state.maxScroll>0?this.state.offsetY/this.state.maxScroll:0)*100; this.jumpToPosition(Math.max(0,Math.min(100,c+d))); }
      handleKeyboard(e) {
        if (e.target.matches('textarea, input, select')) return; let handled = true;
        const changeVal = (el, delta) => { const n = parseInt(el.value)+delta; el.value = Math.max(parseInt(el.min),Math.min(parseInt(el.max),n)); el.dispatchEvent(new Event('input')); };
        switch (e.code) {
          case 'Space': this.togglePlayPause(); break; case 'KeyR': this.reset(); break; case 'KeyF': this.toggleFullscreen(); break; case 'KeyM': this.elements.mirror.checked=!this.elements.mirror.checked; break; case 'KeyS': this.elements.showStats.checked=!this.elements.showStats.checked; this.toggleStats(this.elements.showStats.checked); break; case 'KeyK': this.elements.karaoke.checked=!this.elements.karaoke.checked; this.toggleKaraoke(this.elements.karaoke.checked); break;
          case 'ArrowUp': changeVal(this.elements.speed, 5); break; case 'ArrowDown': changeVal(this.elements.speed, -5); break;
          case 'Equal': case 'NumpadAdd': changeVal(this.elements.fontSize, 2); break; case 'Minus': case 'NumpadSubtract': changeVal(this.elements.fontSize, -2); break;
          case 'KeyW': if(this.elements.karaoke.checked) changeVal(this.elements.karaokeSpeed, 5); break; case 'KeyQ': if(this.elements.karaoke.checked) changeVal(this.elements.karaokeSpeed, -5); break;
          case 'PageDown': this.jumpByPercentage(10); break; case 'PageUp': this.jumpByPercentage(-10); break;
          case 'Home': this.jumpToPosition(0); break; case 'End': this.jumpToPosition(100); break;
          default: handled = false;
        }
        if (handled) e.preventDefault();
      }
      toggleFullscreen() { document.fullscreenElement ? document.exitFullscreen() : this.elements.stage.requestFullscreen(); }

      saveScript() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([this.elements.scriptInput.value],{type:'text/plain;charset=utf-8'})); a.download='guion.txt'; a.click(); URL.revokeObjectURL(a.href); }
      handleFileLoad(e) { if(!e.target.files[0]) return; const r=new FileReader(); r.onload=ev=>{this.elements.scriptInput.value=ev.target.result; this.loadScript();}; r.readAsText(e.target.files[0]); }
      savePreferences() { const prefs = { speed: this.elements.speed.value, fontSize: this.elements.fontSize.value, textWidth: this.elements.textWidth.value, mirror: this.elements.mirror.checked, focusGuide: this.elements.focusGuide.checked, countdown: this.elements.countdown.value, karaoke: this.elements.karaoke.checked, showStats: this.elements.showStats.checked, karaokeSpeed: this.elements.karaokeSpeed.value, textAlign: this.elements.displayText.style.textAlign, theme: this.elements.body.className, script: this.elements.scriptInput.value, voice: this.elements.voiceSelect.value }; localStorage.setItem('teleprompterProPrefs', JSON.stringify(prefs)); }
      loadPreferences() {
        const prefs = JSON.parse(localStorage.getItem('teleprompterProPrefs')); if (!prefs) return;
        Object.keys(prefs).forEach(key => {
            if (key === 'textAlign') this.setTextAlign(prefs[key] || 'left');
            else if (key === 'theme') this.setTheme(prefs[key] || 'theme-dark');
            else if (key === 'script') this.elements.scriptInput.value = prefs[key] || '';
            else if (this.elements[key]) {
                if (key === 'voiceSelect') setTimeout(() => this.elements.voiceSelect.value = prefs.voice, 200);
                else if (typeof this.elements[key].checked !== 'undefined') this.elements[key].checked = prefs[key];
                else this.elements[key].value = prefs[key];
            }
        });
      }
      updateUI() { this.updateSpeedUI(this.elements.speed.value); this.updateFontSizeUI(this.elements.fontSize.value); this.updateTextWidthUI(this.elements.textWidth.value); this.updateKaraokeSpeedUI(this.elements.karaokeSpeed.value); this.elements.viewport.classList.toggle('mirrored',this.elements.mirror.checked); this.elements.stage.classList.toggle('focus-guide-active',this.elements.focusGuide.checked); this.toggleStats(this.elements.showStats.checked); this.toggleKaraoke(this.elements.karaoke.checked); this.setTextAlign(this.elements.displayText.style.textAlign || 'left'); this.setTheme(this.elements.body.className || 'theme-dark'); }
    }
    document.addEventListener('DOMContentLoaded', () => { window.teleprompter = new TeleprompterApp(); });
  </script>
</body>
</html>
